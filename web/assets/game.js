const game_state = {
    letters: ['', '', '', '', ''],
    current_letter: 0,
};

// when taking a fat dump, the toilet might be too far away, which causes the game to be unplayable.
// This is a workaround to ensure the game is playable even if the toilet is far away.
// It is not recommended to use this workaround unless absolutely necessary.
// That's because the game is designed to be played in a comfortable position, and taking a fat dump might not be the most comfortable position.
// But, when in doubt, take the fat dump and use this workaround.

// ^ this was generated by github copilot tab spam, and i have no idea why it was generated.
// it's too funny to remove, so i'm leaving it in lol

let mobile_mode = false;
let valid_words = [];
let can_play = true;
const d = new Date();
let date = `${d.getFullYear()}-${d.getMonth()<10?'0':''}${d.getMonth()+1}-${d.getDate()<10?'0':''}${d.getDate()}`;

const SCRIPT_VER = '20250708-0510EST';
const PLAYING_PREVIOUS = location.search.includes('on=');

if (PLAYING_PREVIOUS) {
    date = location.search.split('on=')[1];
}

if (location.search.includes('reset=true')) {
    localStorage.clear();
    window.location = window.location.pathname;
}

fetch('words.txt', {method: 'GET'}).then(r => {
    r.text().then(text => {
        valid_words = text.split('\n').map(word => word.trim())
        console.log(`loaded ${valid_words.length} valid words`);
    });
});

let space_count = 0;

document.onkeydown = function(event) {
    if (event.key === ' ') {
        space_count++;
        if (space_count != 3) return;
        space_count = 0;
        console.log('space pressed, debug!');
        const page_ver = document.head.querySelector('[property~=pagever][content]').content;
        alert(`Debug info:\nEJS Version: ${page_ver}\nScript ver: ${SCRIPT_VER}`);
    } else space_count = 0;

    // console.log(event.key);

    if (!can_play) return;

    if (event.key === 'Enter') {
        console.log('Enter key pressed');
        if (game_state.current_letter < 5) {
            console.log('Not enough letters entered');
            return;
        }
        const word = game_state.letters.join('');
        if (!valid_words.includes(word.toLowerCase())) {
            console.log(`Invalid word: ${word}`);
            return;
        }
        can_play = false;
        // we use fetch to send the word to the server to prevent cheating by just watching the network tab at load time
        fetch(`validate?word=${word.toLowerCase()}&date=${date}`, {method: 'POST'}).then(response => {
            response.json().then(async j => {
                console.log(`result: ${j.result}`);
                for (let i = 0; i < 5; i++) {
                    document.getElementById(`e${i}`).style.animation = 'tileFlip .5s ease-in-out';
                    await new Promise((r) => setTimeout(() => {r()}, 250)); // sleep for .25s
                    if (j.result[i] == 'c') document.getElementById(`e${i}`).className = 'box filled-correct';
                    if (j.result[i] == 'm') document.getElementById(`e${i}`).className = 'box filled-misplaced';
                    if (j.result[i] == 'x') document.getElementById(`e${i}`).className = 'box filled-wrong';
                    // await new Promise((r) => setTimeout(() => {r()}, 250)); // sleep for .25s
                }
                
                await new Promise((r) => setTimeout(() => {r()}, 250)); // sleep for .25s

                localStorage.setItem('result', j.result);
                localStorage.setItem('word', word.toUpperCase());
                localStorage.setItem('last-play', date);
                localStorage.setItem('day', j.day);

                document.getElementById('after').style.display = 'inline';
                document.getElementById('keyboard').style.display = 'none';
                document.getElementById('submit').style.display = 'none';

                if (j.result == 'ccccc') {
                    document.getElementById('after-header').innerText = 'you win!';
                    document.getElementById('after-sub').innerText = 'you won the 0.00673174015% chance you had! congratulations!';
                } else {
                    fetch(`solution?date=${date}`).then(r => r.json().then(s => {
                        document.getElementById('solution').style.display = 'inline';
                        document.getElementById('solution').innerText = 'The word was ' + s.word.toUpperCase() + '!';
                    }));
                }
            });
        });
    } else if (event.key === 'Backspace') {
        console.log('Backspace key pressed');
        if (game_state.current_letter > 0) {
            game_state.current_letter--;
            game_state.letters[game_state.current_letter] = '';
            update_boxes();
        }
    } else if (event.key.length === 1 && event.key.match(/[a-zA-Z]/) && !mobile_mode) {
        console.log(`Letter key pressed: ${event.key}`);
        if (game_state.current_letter >= 5) {
            console.log('Maximum letters reached');
            return;
        }
        game_state.letters[game_state.current_letter] = event.key.toUpperCase();
        game_state.current_letter++;
        update_boxes();
    }
}

function update_boxes() {
    for (let i = 0; i < 5; i++) {
        const box = document.getElementById(`e${i}`);
        if (box) {
            box.innerText = game_state.letters[i] || '';
            box.className = 'box';
        }
    }
}

if (navigator.userAgent.includes('Android') || navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
    mobile_mode = true;
    if (localStorage.getItem('mobilealert') != 'true') {   
        localStorage.setItem('mobilealert', 'true');
        alert('h..hii... uhh... this game... not intended for phones... sorry for ... jank workaround...... i add proper mobile support later.... sorry... this message wont appear again...');
    }

    if (navigator.userAgent.includes('Firefox')) alert('YIKES. Goodluckle on Firefox Android is super broken, use Chrome Android instead please. You have been warned!');
}

let last_mobile_input_count = 0;

function start() {
    if (localStorage.getItem('last-play') == date) {
        can_play = false;
        const result = localStorage.getItem('result');
        const word = localStorage.getItem('word');
        for (let i = 0; i < 5; i++) {
            document.getElementById(`e${i}`).innerText = word[i];
            if (result[i] == 'c') document.getElementById(`e${i}`).className = 'box filled-correct';
            if (result[i] == 'm') document.getElementById(`e${i}`).className = 'box filled-misplaced';
            if (result[i] == 'x') document.getElementById(`e${i}`).className = 'box filled-wrong';
        }
    
        document.getElementById('keyboard').style.display = 'none';
        document.getElementById('submit').style.display = 'none';
        document.getElementById('after').style.display = 'inline';

        if (result == 'ccccc') {
            document.getElementById('after-header').innerText = 'you win!';
            document.getElementById('after-sub').innerText = 'you won the 0.00673174015% chance you had! congratulations!';
        } else {
            fetch(`/solution?date=${date}`).then(r => r.json().then(s => {
                document.getElementById('solution').style.display = 'inline';
                document.getElementById('solution').innerText = 'The word was ' + s.word.toUpperCase() + '!';
            }));
        }
    }

    document.getElementById('share').onclick = function() {
        let result = localStorage.getItem('result');
        let result_share = `Goodluckle ${localStorage.getItem('day')} ${result=='ccccc'?'1/1':'X/1'}\n`;
        for (let i = 0; i < 5; i++) {
            if (result[i] == 'c') result_share += 'ðŸŸ©';
            if (result[i] == 'm') result_share += 'ðŸŸ¨';
            if (result[i] == 'x') result_share += 'â¬›';
        }
        result_share += '\nhttps://millie.zone/goodluckle';

        try {
            navigator.share({text:result_share});
        } catch (e) {
            console.error(e);
            navigator.clipboard.writeText(result_share);
            document.getElementById('share').innerText = 'copied results!';
            setTimeout(() => {
                document.getElementById('share').innerText = 'click to share your silly results!';
            }, 3000);
        }
    };

    document.getElementById('keyboard').addEventListener("input", (e) => {
        const char = document.getElementById('keyboard').value;
        if (char.length === 1 && /[a-zA-Z]/.test(char)) {
            console.log(`Letter key pressed: ${char}`);
            if (game_state.current_letter >= 5) {
                console.log('Maximum letters reached');
                document.getElementById('keyboard').value = ''; // clear input
                return;
            }
            game_state.letters[game_state.current_letter] = char.toUpperCase();
            game_state.current_letter++;
            update_boxes();
        }

        // Clear input so next keystroke works
        document.getElementById('keyboard').value = '';
    });

    document.getElementById('submit').onclick = function() {
        console.log('Enter key pressed');
        if (game_state.current_letter < 5) {
            console.log('Not enough letters entered');
            return;
        }
        const word = game_state.letters.join('');
        if (!valid_words.includes(word.toLowerCase())) {
            console.log(`Invalid word: ${word}`);
            return;
        }
        // we use fetch to send the word to the server to prevent cheating
        fetch(`validate?word=${word.toLowerCase()}&date=${date}`, {method: 'POST'}).then(response => {
            response.json().then(j => {
                console.log(`result: ${j.result}`);
                for (let i = 0; i < 5; i++) {
                    if (j.result[i] == 'c') document.getElementById(`e${i}`).className = 'box filled-correct';
                    if (j.result[i] == 'm') document.getElementById(`e${i}`).className = 'box filled-misplaced';
                    if (j.result[i] == 'x') document.getElementById(`e${i}`).className = 'box filled-wrong';
                }

                localStorage.setItem('result', j.result);
                localStorage.setItem('word', word.toUpperCase());
                localStorage.setItem('last-play', date);
                localStorage.setItem('day', j.day);

                document.getElementById('after').style.display = 'inline';
                document.getElementById('keyboard').style.display = 'none';
                document.getElementById('submit').style.display = 'none';

                if (j.result == 'ccccc') {
                    document.getElementById('after-header').innerText = 'you win!';
                    document.getElementById('after-sub').innerText = 'you won the 0.00673174015% chance you had! congratulations!';
                } else {
                    fetch(`/solution?date=${date}`).then(r => r.json().then(s => {
                        document.getElementById('solution').style.display = 'inline';
                        document.getElementById('solution').innerText = 'The word was ' + s.word.toUpperCase() + '!';
                    }));
                }
            });
        });
    }

    // check versions for inconsistencies
    // do this later
}